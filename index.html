<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brawl Stars RPG</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nougat&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #1e1e2e;
        color: white;
        overscroll-behavior: none;
      }
      .brawl-font {
        font-family: 'Nougat', 'Roboto', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .text-outline {
        text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
      }
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
      }
      .animate-shake {
        animation: shake 0.5s;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
      // ==========================================
      // 0. REACT SETUP
      // ==========================================
      const { useState, useEffect, useRef } = React;

      // ==========================================
      // 1. CONSTANTS & TYPES
      // ==========================================
      
      // Converted Enums to Const Objects for runtime safety
      const BrawlerClass = {
        DAMAGE_DEALER: 'Damage Dealer',
        TANK: 'Tank',
        MARKSMAN: 'Marksman',
        SUPPORT: 'Support',
        ASSASSIN: 'Assassin',
        CONTROLLER: 'Controller',
        ARTILLERY: 'Artillery'
      };

      const BrawlerRarity = {
        COMMON: 'Common',
        RARE: 'Rare',
        SUPER_RARE: 'Super Rare',
        EPIC: 'Epic',
        MYTHIC: 'Mythic',
        LEGENDARY: 'Legendary'
      };

      // Game Config Constants
      const DUPLICATE_COIN_REWARD = 200;
      const UPGRADE_BASE_COST = 100;
      const UPGRADE_COST_PER_LEVEL = 100;
      const HP_PER_UPGRADE = 200;
      const ATTACK_PER_UPGRADE = 50;
      const POTION_COST = 150;
      const POTION_HEAL_AMOUNT = 2000;

      const RARITY_INFO = {
        [BrawlerRarity.COMMON]: { 
          color: 'text-gray-400', 
          border: 'border-gray-400', 
          bg: 'bg-gray-800', 
          shadow: 'shadow-gray-500/50',
          label: 'COMMON'
        },
        [BrawlerRarity.RARE]: { 
          color: 'text-green-400', 
          border: 'border-green-400', 
          bg: 'bg-green-900', 
          shadow: 'shadow-green-500/50',
          label: 'RARE'
        },
        [BrawlerRarity.SUPER_RARE]: { 
          color: 'text-blue-400', 
          border: 'border-blue-400', 
          bg: 'bg-blue-900', 
          shadow: 'shadow-blue-500/50',
          label: 'SUPER RARE'
        },
        [BrawlerRarity.EPIC]: { 
          color: 'text-purple-400', 
          border: 'border-purple-400', 
          bg: 'bg-purple-900', 
          shadow: 'shadow-purple-500/50',
          label: 'EPIC'
        },
        [BrawlerRarity.MYTHIC]: { 
          color: 'text-red-500', 
          border: 'border-red-500', 
          bg: 'bg-red-900', 
          shadow: 'shadow-red-500/50',
          label: 'MYTHIC'
        },
        [BrawlerRarity.LEGENDARY]: { 
          color: 'text-yellow-400', 
          border: 'border-yellow-400', 
          bg: 'bg-yellow-900', 
          shadow: 'shadow-yellow-500/50',
          label: 'LEGENDARY'
        }
      };

      const BRAWLERS = [
        // COMMON (Start / Cheap)
        {
          id: 'shelly',
          name: 'Shelly',
          class: BrawlerClass.DAMAGE_DEALER,
          rarity: BrawlerRarity.COMMON,
          hp: 3800,
          maxHp: 3800,
          attack: 800,
          superName: 'Super Shell',
          superDamage: 1500,
          superDescription: 'Destroys cover and enemies.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/0.png',
          price: 0
        },
        {
          id: 'nita',
          name: 'Nita',
          class: BrawlerClass.CONTROLLER,
          rarity: BrawlerRarity.COMMON,
          hp: 4000,
          maxHp: 4000,
          attack: 700,
          superName: 'Overbearing',
          superDamage: 1200,
          superDescription: 'Summons a spirit bear.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/1.png',
          price: 1000
        },
        {
          id: 'colt',
          name: 'Colt',
          class: BrawlerClass.DAMAGE_DEALER,
          rarity: BrawlerRarity.COMMON,
          hp: 2800,
          maxHp: 2800,
          attack: 900,
          superName: 'Bullet Storm',
          superDamage: 1800,
          superDescription: 'A long-range barrage of bullets.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/2.png',
          price: 1000
        },
        {
          id: 'bull',
          name: 'Bull',
          class: BrawlerClass.TANK,
          rarity: BrawlerRarity.COMMON,
          hp: 5000,
          maxHp: 5000,
          attack: 1000,
          superName: 'Bulldozer',
          superDamage: 1200,
          superDescription: 'Charges forward, knocking back enemies.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/3.png',
          price: 1000
        },

        // RARE
        {
          id: 'el_primo',
          name: 'El Primo',
          class: BrawlerClass.TANK,
          rarity: BrawlerRarity.RARE,
          hp: 6000,
          maxHp: 6000,
          attack: 800,
          superName: 'Flying Elbow Drop',
          superDamage: 1600,
          superDescription: 'Leaps high and drops an elbow.',
          superCharge: 0,
          superChargeRate: 15,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/6.png',
          price: 2500
        },
        {
          id: 'barley',
          name: 'Barley',
          class: BrawlerClass.ARTILLERY,
          rarity: BrawlerRarity.RARE,
          hp: 2400,
          maxHp: 2400,
          attack: 700,
          superName: 'Last Call',
          superDamage: 1400,
          superDescription: 'Hurls bottles creating a sea of fire.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/7.png',
          price: 2500
        },
        {
          id: 'poco',
          name: 'Poco',
          class: BrawlerClass.SUPPORT,
          rarity: BrawlerRarity.RARE,
          hp: 3800,
          maxHp: 3800,
          attack: 600,
          superName: 'Encore',
          superDamage: -2000, // Negative for healing
          superDescription: 'Heals himself and teammates.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/8.png',
          price: 2500
        },
        {
          id: 'brock',
          name: 'Brock',
          class: BrawlerClass.MARKSMAN,
          rarity: BrawlerRarity.RARE,
          hp: 2800,
          maxHp: 2800,
          attack: 1100,
          superName: 'Rocket Rain',
          superDamage: 2000,
          superDescription: 'Fires a barrage of rockets.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/4.png',
          price: 2500
        },

        // SUPER RARE
        {
          id: 'jessie',
          name: 'Jessie',
          class: BrawlerClass.CONTROLLER,
          rarity: BrawlerRarity.SUPER_RARE,
          hp: 3000,
          maxHp: 3000,
          attack: 820,
          superName: 'Scrappy!',
          superDamage: 1200,
          superDescription: 'Deploys a cute but deadly turret.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/5.png',
          price: 5000
        },
        {
          id: 'dynamike',
          name: 'Dynamike',
          class: BrawlerClass.ARTILLERY,
          rarity: BrawlerRarity.SUPER_RARE,
          hp: 2800,
          maxHp: 2800,
          attack: 1600,
          superName: 'Big Barrel o\' Boom',
          superDamage: 2200,
          superDescription: 'Throws a big barrel of dynamite.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/9.png',
          price: 5000
        },
        {
          id: 'rico',
          name: 'Rico',
          class: BrawlerClass.DAMAGE_DEALER,
          rarity: BrawlerRarity.SUPER_RARE,
          hp: 2600,
          maxHp: 2600,
          attack: 900,
          superName: 'Trick Shot',
          superDamage: 1800,
          superDescription: 'Bullets bounce off walls.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/12.png',
          price: 5000
        },

        // EPIC
        {
          id: 'piper',
          name: 'Piper',
          class: BrawlerClass.MARKSMAN,
          rarity: BrawlerRarity.EPIC,
          hp: 2400,
          maxHp: 2400,
          attack: 1520,
          superName: 'Poppin\'',
          superDamage: 1800,
          superDescription: 'Jumps away leaving grenades behind.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/15.png',
          price: 10000
        },
        {
          id: 'frank',
          name: 'Frank',
          class: BrawlerClass.TANK,
          rarity: BrawlerRarity.EPIC,
          hp: 7000,
          maxHp: 7000,
          attack: 1200,
          superName: 'Stunning Blow',
          superDamage: 1200,
          superDescription: 'Stuns enemies with a hammer smash.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/20.png',
          price: 10000
        },
        {
          id: 'bibi',
          name: 'Bibi',
          class: BrawlerClass.TANK,
          rarity: BrawlerRarity.EPIC,
          hp: 4400,
          maxHp: 4400,
          attack: 1300,
          superName: 'Spitball',
          superDamage: 1000,
          superDescription: 'Bats a bouncing bubble of gum.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/26.png',
          price: 10000
        },

        // MYTHIC
        {
          id: 'mortis',
          name: 'Mortis',
          class: BrawlerClass.ASSASSIN,
          rarity: BrawlerRarity.MYTHIC,
          hp: 3800,
          maxHp: 3800,
          attack: 900,
          superName: 'Life Blood',
          superDamage: 900, // Also heals
          superDescription: 'Summons bats that damage and heal.',
          superCharge: 0,
          superChargeRate: 25,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/13.png',
          price: 25000
        },
        {
          id: 'tara',
          name: 'Tara',
          class: BrawlerClass.DAMAGE_DEALER,
          rarity: BrawlerRarity.MYTHIC,
          hp: 3400,
          maxHp: 3400,
          attack: 1000,
          superName: 'Gravity',
          superDamage: 1200,
          superDescription: 'Creates a black hole.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/14.png',
          price: 25000
        },

        // LEGENDARY
        {
          id: 'spike',
          name: 'Spike',
          class: BrawlerClass.DAMAGE_DEALER,
          rarity: BrawlerRarity.LEGENDARY,
          hp: 2400,
          maxHp: 2400,
          attack: 1200,
          superName: 'Stick Around!',
          superDamage: 1400,
          superDescription: 'Slows and damages enemies in area.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/16.png',
          price: 50000
        },
        {
          id: 'crow',
          name: 'Crow',
          class: BrawlerClass.ASSASSIN,
          rarity: BrawlerRarity.LEGENDARY,
          hp: 2400,
          maxHp: 2400,
          attack: 800,
          superName: 'Swoop',
          superDamage: 1000,
          superDescription: 'Jumps and throws poisoned daggers.',
          superCharge: 0,
          superChargeRate: 15,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/17.png',
          price: 50000
        },
        {
          id: 'leon',
          name: 'Leon',
          class: BrawlerClass.ASSASSIN,
          rarity: BrawlerRarity.LEGENDARY,
          hp: 3200,
          maxHp: 3200,
          attack: 1400,
          superName: 'Smoke Bomb',
          superDamage: 0, // Invisibility logic handled elsewhere or treated as buff
          superDescription: 'Becomes invisible for a short time.',
          superCharge: 0,
          superChargeRate: 20,
          avatarUrl: 'https://cdn.brawlify.com/brawlers/borders/21.png',
          price: 50000
        }
      ];

      const ENEMIES = [
          ...BRAWLERS.filter(b => b.id !== 'shelly').map(b => ({...b, hp: Math.floor(b.hp * 1.2), maxHp: Math.floor(b.maxHp * 1.2), attack: Math.floor(b.attack * 0.8)}))
      ];

      const BOXES = [
          {
              id: 'brawl_box',
              name: 'Brawl Box',
              cost: 100,
              color: 'bg-blue-600',
              icon: 'üì¶',
              minCoins: 10,
              maxCoins: 50,
              brawlerChance: 0.1
          },
          {
              id: 'big_box',
              name: 'Big Box',
              cost: 300,
              color: 'bg-purple-600',
              icon: 'üéÅ',
              minCoins: 40,
              maxCoins: 120,
              brawlerChance: 0.25
          },
          {
              id: 'mega_box',
              name: 'Mega Box',
              cost: 800,
              color: 'bg-yellow-500',
              icon: 'üíé',
              minCoins: 150,
              maxCoins: 500,
              brawlerChance: 0.5
          }
      ];

      // ==========================================
      // 2. SERVICES
      // ==========================================

      const FALLBACK_COMMENTARY = [
        "ÏóÑÏ≤≠ÎÇú Ï†ÑÌà¨Í∞Ä Î≤åÏñ¥ÏßÄÍ≥† ÏûàÏäµÎãàÎã§! üî•",
        "Í¥ÄÏ§ëÎì§Ïù¥ ÌôòÌò∏Ìï©ÎãàÎã§! üëè",
        "Ï†ïÎßê ÎØøÏùÑ Ïàò ÏóÜÎäî ÌîåÎ†àÏù¥Íµ∞Ïöî! ‚ö°",
        "ÏäπÎ∂ÄÎäî ÏïÑÏßÅ Ïïå Ïàò ÏóÜÏäµÎãàÎã§! ‚öîÔ∏è",
        "Í∞ïÎ†•Ìïú Ìïú Î∞©ÏûÖÎãàÎã§! üí•",
        "Ïà®ÎßâÌûàÎäî Ï†ëÏ†ÑÏûÖÎãàÎã§! üò∞",
        "ÎåÄÎã®Ìïú ÌîºÏßÄÏª¨Ïù¥ÎÑ§Ïöî! üí™",
        "ÏïÑÏä¨ÏïÑÏä¨Ìïú ÏàúÍ∞ÑÏù¥ Í≥ÑÏÜçÎê©ÎãàÎã§! ‚è±Ô∏è",
        "Ï†ÑÏÑ§Ï†ÅÏù∏ Î™ÖÍ≤ΩÍ∏∞Í∞Ä ÌÉÑÏÉùÌïòÎÇòÏöî? üèÜ"
      ];

      const generateBattleCommentary = async (
        action,
        actor,
        target,
        result
      ) => {
        // AI functionality removed. Returning random fallback commentary.
        return FALLBACK_COMMENTARY[Math.floor(Math.random() * FALLBACK_COMMENTARY.length)];
      };

      // ==========================================
      // 3. COMPONENTS
      // ==========================================

      const BrawlerCard = ({ 
        brawler, 
        isPlayer = false, 
        isActive = false, 
        isSelected = false,
        onClick,
        showHealthBar = false,
        isDamaged = false,
        isLocked = false,
        canBuy = false,
        onBuy
      }) => {
        const hpPercent = Math.max(0, Math.min(100, (brawler.hp / brawler.maxHp) * 100));
        const superPercent = Math.max(0, Math.min(100, brawler.superCharge));
        
        // Get rarity styling, default to Common if missing
        const rarityStyle = RARITY_INFO[brawler.rarity] || RARITY_INFO[BrawlerRarity.COMMON];
        const borderColor = isSelected ? 'border-white' : isLocked ? 'border-gray-700' : rarityStyle.border;
        const shadowClass = isActive ? 'shadow-[0_0_20px_rgba(250,204,21,0.6)]' : isSelected ? 'shadow-[0_0_25px_rgba(255,255,255,0.8)]' : '';

        return (
          <div 
            onClick={!isLocked ? onClick : undefined}
            className={`
              relative p-3 rounded-xl border-4 transition-all duration-300 transform
              ${isActive ? 'scale-105 border-yellow-400 z-10' : ''}
              ${isSelected ? 'scale-105 z-10 bg-slate-700' : ''}
              ${borderColor}
              ${!isActive && !isSelected ? `border-opacity-80` : ''}
              ${!isLocked && !isActive && !isSelected ? 'hover:scale-105 hover:brightness-110' : ''}
              ${isPlayer ? 'bg-slate-800' : 'bg-gray-900'}
              ${isLocked ? 'bg-gray-900 grayscale opacity-90' : ''}
              ${isDamaged ? 'animate-shake' : ''}
              ${!isLocked ? 'cursor-pointer' : 'cursor-default'}
              ${shadowClass}
              overflow-hidden
            `}
          >
            <div className="absolute top-0 right-0 p-2 opacity-50 text-5xl font-black italic select-none pointer-events-none z-0">
              {brawler.class.substring(0, 1)}
            </div>

            {isLocked && (
              <div className="absolute inset-0 z-30 bg-black/70 flex flex-col items-center justify-center backdrop-blur-[2px]">
                <div className="mb-2 text-gray-400">
                   <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                {onBuy && (
                   <button
                      onClick={canBuy ? onBuy : undefined}
                      className={`
                         flex items-center gap-1 px-4 py-2 rounded-full font-bold text-sm shadow-lg transition-all
                         ${canBuy ? 'bg-yellow-500 hover:bg-yellow-400 text-black hover:scale-105 active:scale-95 cursor-pointer' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}
                      `}
                   >
                      <span className="text-xs">$</span>
                      {brawler.price.toLocaleString()}
                   </button>
                )}
                {!onBuy && (
                    <span className="text-yellow-500 font-bold text-xl">${brawler.price.toLocaleString()}</span>
                )}
              </div>
            )}

            {/* Selected Indicator */}
            {isSelected && (
              <div className="absolute top-2 left-2 z-20 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-lg animate-pulse">
                  PICKED!
              </div>
            )}

            <div className="flex flex-col items-center z-10 relative">
              <div className={`w-20 h-20 rounded-lg border-2 ${borderColor} overflow-hidden mb-2 bg-black`}>
                <img src={brawler.avatarUrl} alt={brawler.name} className="w-full h-full object-cover" />
              </div>
              
              <h3 className={`text-lg font-bold text-center brawl-font text-outline leading-none mb-1 ${isLocked ? 'text-gray-400' : rarityStyle.color}`}>
                  {brawler.name}
              </h3>
              
              {!showHealthBar && (
                  <span className={`text-[10px] uppercase font-bold tracking-widest mb-2 px-2 py-0.5 rounded bg-black/40 ${rarityStyle.color}`}>
                      {rarityStyle.label}
                  </span>
              )}

              {showHealthBar && (
                <div className="w-full space-y-1 mt-1">
                  <div className="relative w-full h-4 bg-gray-900 rounded-full border border-gray-600 overflow-hidden">
                    <div 
                      className={`h-full transition-all duration-500 ease-out ${isPlayer ? 'bg-green-500' : 'bg-red-500'}`}
                      style={{ width: `${hpPercent}%` }}
                    />
                    <span className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white shadow-black drop-shadow-md">
                      {brawler.hp} / {brawler.maxHp}
                    </span>
                  </div>
                  
                  {/* Super Bar */}
                  <div className="relative w-full h-2 bg-gray-900 rounded-full border border-gray-600 overflow-hidden">
                    <div 
                      className={`h-full transition-all duration-300 ease-out ${superPercent >= 100 ? 'bg-yellow-400 animate-pulse' : 'bg-blue-400'}`}
                      style={{ width: `${superPercent}%` }}
                    />
                  </div>
                </div>
              )}

              {!showHealthBar && (
                <div className="grid grid-cols-2 gap-1 w-full text-xs mt-1">
                  <div className={`p-1 rounded text-center ${isLocked ? 'bg-gray-800/50 text-gray-500' : 'bg-gray-800'}`}>
                    <span className={`block font-bold text-[10px] ${isLocked ? 'text-gray-600' : 'text-red-400'}`}>ATK</span>
                    {brawler.attack}
                  </div>
                   <div className={`p-1 rounded text-center ${isLocked ? 'bg-gray-800/50 text-gray-500' : 'bg-gray-800'}`}>
                    <span className={`block font-bold text-[10px] ${isLocked ? 'text-gray-600' : 'text-green-400'}`}>HP</span>
                    {brawler.maxHp}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // ==========================================
      // 4. MAIN APP LOGIC
      // ==========================================

      const App = () => {
        const [gameState, setGameState] = useState({
          status: 'MENU',
          player: null,
          enemy: null,
          turn: 'PLAYER',
          log: [],
          commentary: "Î∏åÎ°§ Ïä§ÌÉÄÏ¶à RPGÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§! Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!",
          wins: 0,
          coins: 500, // Start with some coins to try the box
          lastReward: 0,
          unlockedBrawlerIds: ['shelly'], // Shelly starts unlocked
          brawlerUpgrades: {}, // Initialize empty
          potions: 3 // Start with 3 free potions
        });

        const [selectedBrawlerId, setSelectedBrawlerId] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);
        const [damageEffect, setDamageEffect] = useState(null);
        
        // For box opening animation
        const [boxState, setBoxState] = useState('IDLE');
        const [activeBox, setActiveBox] = useState(null);
        const [boxReward, setBoxReward] = useState(null);

        const logsEndRef = useRef(null);

        // Auto-scroll logs
        useEffect(() => {
          logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [gameState.log]);

        const addLog = (text, type = 'info') => {
          setGameState(prev => ({
            ...prev,
            log: [...prev.log, { id: Date.now(), text, type }]
          }));
        };

        const updateCommentary = async (action, actor, target, result) => {
          // Always call generateBattleCommentary. The service handles missing keys or API errors by returning a fallback string.
          const comment = await generateBattleCommentary(action, actor, target, result);
          setGameState(prev => ({ ...prev, commentary: comment }));
        };

        const buyBrawler = (brawler) => {
          if (gameState.coins >= brawler.price) {
            setGameState(prev => ({
              ...prev,
              coins: prev.coins - brawler.price,
              unlockedBrawlerIds: [...prev.unlockedBrawlerIds, brawler.id]
            }));
          }
        };

        const buyPotion = () => {
            if (gameState.coins >= POTION_COST) {
                setGameState(prev => ({
                    ...prev,
                    coins: prev.coins - POTION_COST,
                    potions: prev.potions + 1
                }));
            }
        };

        const upgradeBrawler = (brawlerId) => {
          const currentUpgrade = gameState.brawlerUpgrades[brawlerId] || { level: 1, extraHp: 0, extraAttack: 0 };
          const cost = UPGRADE_BASE_COST + (currentUpgrade.level * UPGRADE_COST_PER_LEVEL);

          if (gameState.coins >= cost) {
              setGameState(prev => ({
                  ...prev,
                  coins: prev.coins - cost,
                  brawlerUpgrades: {
                      ...prev.brawlerUpgrades,
                      [brawlerId]: {
                          level: currentUpgrade.level + 1,
                          extraHp: currentUpgrade.extraHp + HP_PER_UPGRADE,
                          extraAttack: currentUpgrade.extraAttack + ATTACK_PER_UPGRADE
                      }
                  }
              }));
          }
        };

        const openBox = (box) => {
          if (gameState.coins < box.cost) return;

          setActiveBox(box);
          setGameState(prev => ({ ...prev, coins: prev.coins - box.cost }));
          setBoxState('SHAKING');

          setTimeout(() => {
              setBoxState('OPENING');
              setTimeout(() => {
                  // Logic to pick reward
                  const isBrawlerDrop = Math.random() < box.brawlerChance;

                  if (isBrawlerDrop) {
                      const randomBrawler = BRAWLERS[Math.floor(Math.random() * BRAWLERS.length)];
                      const isOwned = gameState.unlockedBrawlerIds.includes(randomBrawler.id);

                      if (!isOwned) {
                          setBoxReward({ type: 'NEW_BRAWLER', item: randomBrawler, coins: 0 });
                          setGameState(prev => ({
                              ...prev,
                              unlockedBrawlerIds: [...prev.unlockedBrawlerIds, randomBrawler.id]
                          }));
                      } else {
                          setBoxReward({ type: 'DUPLICATE', item: randomBrawler, coins: DUPLICATE_COIN_REWARD });
                          setGameState(prev => ({
                              ...prev,
                              coins: prev.coins + DUPLICATE_COIN_REWARD
                          }));
                      }
                  } else {
                      // Coin Drop
                      const coinAmount = Math.floor(Math.random() * (box.maxCoins - box.minCoins + 1)) + box.minCoins;
                      setBoxReward({ type: 'COINS', item: null, coins: coinAmount });
                      setGameState(prev => ({
                          ...prev,
                          coins: prev.coins + coinAmount
                      }));
                  }
                  setBoxState('REVEALED');
              }, 1000);
          }, 1000);
        };

        const closeBoxReveal = () => {
            setBoxState('IDLE');
            setBoxReward(null);
            setActiveBox(null);
        };

        const selectBrawler = (brawler) => {
          if (selectedBrawlerId === brawler.id) {
            setSelectedBrawlerId(null);
          } else {
            setSelectedBrawlerId(brawler.id);
          }
        };

        const startGame = () => {
          const baseBrawler = BRAWLERS.find(b => b.id === selectedBrawlerId);
          if (!baseBrawler) return;

          // Apply Upgrades
          const upgrades = gameState.brawlerUpgrades[baseBrawler.id] || { level: 1, extraHp: 0, extraAttack: 0 };
          const playerBrawler = {
              ...baseBrawler,
              hp: baseBrawler.hp + upgrades.extraHp,
              maxHp: baseBrawler.maxHp + upgrades.extraHp,
              attack: baseBrawler.attack + upgrades.extraAttack
          };

          setGameState(prev => ({
            ...prev,
            status: 'BATTLE',
            player: playerBrawler,
            enemy: { ...ENEMIES[0] }, // Start with first enemy
            turn: 'PLAYER',
            log: [{ id: Date.now(), text: 'Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', type: 'info' }],
            commentary: `${playerBrawler.name} (Lv.${upgrades.level}) Ï∂úÍ≤©! Ï†ÑÌà¨ Ï§ÄÎπÑ ÏôÑÎ£å!`,
            wins: 0,
            lastReward: 0
          }));
        };

        const goToMenu = () => {
          setGameState(prev => ({
            ...prev,
            status: 'MENU',
            player: null,
            enemy: null
          }));
          setSelectedBrawlerId(null);
        };

        const goToCharacterSelect = () => {
          setGameState(prev => ({
            ...prev,
            status: 'SELECT_CHARACTER'
          }));
        };

        const goToShop = () => {
          setGameState(prev => ({
              ...prev,
              status: 'SHOP'
          }));
        };

        const goToBlacksmith = () => {
          setGameState(prev => ({
              ...prev,
              status: 'BLACKSMITH'
          }));
        };

        const nextLevel = () => {
          if (!gameState.player) return;
          
          // Heal player 50% on next level
          const newPlayerHp = Math.min(gameState.player.maxHp, gameState.player.hp + Math.floor(gameState.player.maxHp * 0.5));
          
          // Pick random enemy or next in line
          const nextEnemyIndex = (gameState.wins + 1) % ENEMIES.length;
          // Scale enemy stats based on wins
          const baseEnemy = ENEMIES[nextEnemyIndex];
          const scaledEnemy = {
              ...baseEnemy,
              maxHp: Math.floor(baseEnemy.maxHp * (1 + gameState.wins * 0.2)),
              hp: Math.floor(baseEnemy.maxHp * (1 + gameState.wins * 0.2)),
              attack: Math.floor(baseEnemy.attack * (1 + gameState.wins * 0.1)),
          };

          setGameState(prev => ({
            ...prev,
            status: 'BATTLE',
            player: { ...prev.player, hp: newPlayerHp },
            enemy: scaledEnemy,
            turn: 'PLAYER',
            log: [...prev.log, { id: Date.now(), text: `Îã§Ïùå ÎùºÏö¥Îìú! ${scaledEnemy.name} Îì±Ïû•!`, type: 'info' }],
            commentary: "ÏÉàÎ°úÏö¥ ÎèÑÏ†ÑÏûêÍ∞Ä ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§! Ï§ÄÎπÑÌïòÏÑ∏Ïöî!",
            wins: prev.wins + 1,
            lastReward: 0
          }));
        };

        const checkWinCondition = (currentPlayer, currentEnemy) => {
          if (currentEnemy.hp <= 0) {
            const reward = 100 + (gameState.wins * 50); // Base 100 + 50 per win streak
            
            setTimeout(() => {
              setGameState(prev => ({ 
                  ...prev, 
                  status: 'VICTORY',
                  coins: prev.coins + reward,
                  lastReward: reward
              }));
              addLog(`${currentEnemy.name} Ï≤òÏπò ÏôÑÎ£å! ÏäπÎ¶¨! (+${reward} ÏΩîÏù∏)`, 'info');
            }, 1000);
            return true;
          }
          if (currentPlayer.hp <= 0) {
            setTimeout(() => {
              setGameState(prev => ({ ...prev, status: 'DEFEAT' }));
              addLog(`${currentPlayer.name} Ïì∞Îü¨Ïßê... Ìå®Î∞∞.`, 'info');
            }, 1000);
            return true;
          }
          return false;
        };

        const handlePlayerAction = async (actionType) => {
          if (gameState.turn !== 'PLAYER' || isProcessing || !gameState.player || !gameState.enemy) return;

          setIsProcessing(true);
          const player = { ...gameState.player };
          let enemy = { ...gameState.enemy };
          
          let damage = 0;
          let logText = '';
          let actionName = '';

          if (actionType === 'POTION') {
              if (gameState.potions <= 0) {
                  setIsProcessing(false);
                  return;
              }
              
              // Consume potion
              const healAmount = Math.min(POTION_HEAL_AMOUNT, player.maxHp - player.hp);
              player.hp += healAmount;
              
              setGameState(prev => ({
                  ...prev,
                  potions: prev.potions - 1
              }));
              
              actionName = 'ÌöåÎ≥µ Î¨ºÏïΩ';
              logText = `${player.name}Í∞Ä Î¨ºÏïΩÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ${healAmount} Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌñàÏäµÎãàÎã§!`;
              addLog(logText, 'heal');
              
              // Slightly delay enemy turn
              setGameState(prev => ({
                  ...prev,
                  player,
                  turn: 'ENEMY'
              }));
              
              updateCommentary('ÌöåÎ≥µ', player.name, 'ÏûêÏã†', `${healAmount} ÌöåÎ≥µ`);
              
              setTimeout(() => handleEnemyTurn(player, enemy), 1500);
              return;
          }

          if (actionType === 'ATTACK') {
              damage = player.attack;
              actionName = 'ÏùºÎ∞ò Í≥µÍ≤©';
              logText = `${player.name}Ïùò Í≥µÍ≤©! ${damage} ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§.`;
              
              // Charge super
              player.superCharge = Math.min(100, player.superCharge + player.superChargeRate);
          } else {
              // Super
              actionName = player.superName;
              if (player.superDamage < 0) {
                  // Healing Super
                  const healAmount = Math.abs(player.superDamage);
                  player.hp = Math.min(player.maxHp, player.hp + healAmount);
                  logText = `${player.name}Ïùò Í∂ÅÍ∑πÍ∏∞! ${healAmount} Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌñàÏäµÎãàÎã§.`;
                  damage = 0;
              } else {
                  damage = player.superDamage;
                  logText = `${player.name}Ïùò Í∂ÅÍ∑πÍ∏∞ Î∞úÎèô! ${enemy.name}ÏóêÍ≤å ${damage}Ïùò ÏπòÎ™ÖÏ†ÅÏù∏ ÌîºÌï¥!`;
              }
              player.superCharge = 0; // Reset charge
          }

          // Apply damage to enemy
          if (damage > 0) {
              enemy.hp = Math.max(0, enemy.hp - damage);
              setDamageEffect('enemy');
              setTimeout(() => setDamageEffect(null), 500);
          }

          addLog(logText, actionType === 'SUPER' ? 'super' : 'damage');
          
          // Update State immediately for UI feedback
          setGameState(prev => ({
              ...prev,
              player,
              enemy,
              turn: 'ENEMY' // Pass turn tentatively, will verify win condition first
          }));

          // Generate Commentary without blocking too much
          updateCommentary(actionName, player.name, damage > 0 ? enemy.name : 'ÏûêÏã†', `${damage > 0 ? damage + ' Îç∞ÎØ∏ÏßÄ' : 'ÌöåÎ≥µ'}`);

          if (checkWinCondition(player, enemy)) {
              setIsProcessing(false);
              return;
          }

          // Enemy Turn Delay
          setTimeout(() => handleEnemyTurn(player, enemy), 1500);
        };

        const handleEnemyTurn = async (currentPlayer, currentEnemy) => {
          // Re-check win condition just in case
          if (currentEnemy.hp <= 0 || currentPlayer.hp <= 0) {
              setIsProcessing(false);
              return;
          }

          let enemy = { ...currentEnemy };
          let player = { ...currentPlayer };

          // Simple AI: Use Super if ready, otherwise Attack
          const useSuper = enemy.superCharge >= 100;
          let damage = 0;
          let actionName = '';

          if (useSuper) {
              damage = enemy.superDamage;
              actionName = enemy.superName;
              enemy.superCharge = 0;
              addLog(`${enemy.name}Ïùò ${enemy.superName}! Í∞ïÎ†•Ìïú Í≥µÍ≤©!`, 'super');
          } else {
              damage = enemy.attack;
              actionName = 'Í≥µÍ≤©';
              enemy.superCharge = Math.min(100, enemy.superCharge + enemy.superChargeRate);
              addLog(`${enemy.name}Ïù¥ Í≥µÍ≤©Ìï©ÎãàÎã§. ${damage} ÌîºÌï¥Î•º ÏûÖÏùå.`, 'damage');
          }

          player.hp = Math.max(0, player.hp - damage);
          setDamageEffect('player');
          setTimeout(() => setDamageEffect(null), 500);

          setGameState(prev => ({
              ...prev,
              player,
              enemy,
              turn: 'PLAYER'
          }));

          // updateCommentary(actionName, enemy.name, player.name, `${damage} Îç∞ÎØ∏ÏßÄ`); // Optional: Comment on enemy moves too
          
          if (!checkWinCondition(player, enemy)) {
              setIsProcessing(false);
          } else {
              setIsProcessing(false);
          }
        };

        // --- Renders ---

        const renderCoinDisplay = () => (
            <div className="absolute top-4 right-4 bg-black/50 backdrop-blur-md border border-yellow-500/30 px-6 py-2 rounded-full flex items-center gap-2 shadow-xl z-50">
              <div className="w-6 h-6 rounded-full bg-yellow-400 border-2 border-yellow-200 flex items-center justify-center shadow-inner text-yellow-800 font-black text-xs">$</div>
              <span className="text-yellow-400 font-black text-xl tracking-wider">{gameState.coins.toLocaleString()}</span>
            </div>
        );

        const renderMenu = () => (
          <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gradient-to-b from-blue-900 to-slate-900 relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute inset-0 bg-[url('https://picsum.photos/seed/brawlbg/1920/1080')] bg-cover bg-center opacity-30"></div>
            
            {renderCoinDisplay()}

            <div className="relative z-10 text-center mb-12 animate-float">
              <h1 className="text-7xl md:text-9xl font-black text-yellow-400 text-outline mb-4 font-sans tracking-tighter drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">
                BRAWL RPG
              </h1>
              <p className="text-2xl text-cyan-300 font-bold text-outline">Î∏åÎ°§Ïä§ÌÉÄÏ¶à RPG Î∞∞ÌãÄ</p>
            </div>

            <div className="flex flex-col gap-4 relative z-10 w-full max-w-md">
              <button 
                  onClick={goToCharacterSelect}
                  className="group bg-yellow-500 hover:bg-yellow-400 text-black font-black text-3xl py-6 px-16 rounded-2xl shadow-[0_6px_0_rgb(161,98,7)] active:shadow-none active:translate-y-2 transition-all duration-150 transform hover:scale-105"
              >
                  BRAWLERS
              </button>
              <button 
                  onClick={goToBlacksmith}
                  className="group bg-orange-700 hover:bg-orange-600 text-white font-black text-2xl py-4 px-16 rounded-2xl shadow-[0_6px_0_rgb(124,45,18)] active:shadow-none active:translate-y-2 transition-all duration-150 transform hover:scale-105 flex items-center justify-center gap-3"
              >
                  <span>‚öíÔ∏è</span> BLACKSMITH
              </button>
              <button 
                  onClick={goToShop}
                  className="group bg-purple-600 hover:bg-purple-500 text-white font-black text-2xl py-4 px-16 rounded-2xl shadow-[0_6px_0_rgb(88,28,135)] active:shadow-none active:translate-y-2 transition-all duration-150 transform hover:scale-105 flex items-center justify-center gap-3"
              >
                  <span className="text-3xl">üì¶</span> SHOP
              </button>
            </div>

            <div className="absolute bottom-8 text-slate-500 font-bold text-sm">
              Single Player Edition
            </div>
          </div>
        );

        const renderBlacksmith = () => (
            <div className="flex flex-col items-center min-h-screen bg-slate-900 relative pb-10">
              {renderCoinDisplay()}
              
              {/* Background */}
              <div className="absolute inset-0 bg-orange-950/80 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
              
              {/* Header */}
              <div className="w-full max-w-6xl p-4 flex items-center justify-between sticky top-0 bg-slate-900/95 backdrop-blur z-30 border-b border-orange-800 mb-6">
                  <button 
                      onClick={goToMenu} 
                      className="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-white shadow-md transition-colors border border-gray-600"
                  >
                      ‚Üê Back
                  </button>
                  <h2 className="text-3xl font-black text-orange-500 text-center flex-1 text-outline tracking-wider flex items-center justify-center gap-2">
                      ‚öíÔ∏è BLACKSMITH
                  </h2>
                  <div className="w-20"></div>
              </div>

              <div className="max-w-4xl w-full grid gap-4 px-4 z-10">
                  {BRAWLERS.filter(b => gameState.unlockedBrawlerIds.includes(b.id)).map(brawler => {
                      const upgrade = gameState.brawlerUpgrades[brawler.id] || { level: 1, extraHp: 0, extraAttack: 0 };
                      const cost = UPGRADE_BASE_COST + (upgrade.level * UPGRADE_COST_PER_LEVEL);
                      const canAfford = gameState.coins >= cost;

                      return (
                          <div key={brawler.id} className="bg-slate-800 rounded-xl p-4 border border-gray-700 flex flex-col md:flex-row items-center gap-4 shadow-lg">
                              {/* Avatar */}
                              <div className="relative">
                                  <div className="w-20 h-20 rounded-lg overflow-hidden border-2 border-gray-500">
                                      <img src={brawler.avatarUrl} alt={brawler.name} className="w-full h-full object-cover" />
                                  </div>
                                  <div className="absolute -bottom-2 -right-2 bg-orange-600 text-white text-xs font-bold px-2 py-1 rounded border border-white">
                                      Lv.{upgrade.level}
                                  </div>
                              </div>

                              {/* Info */}
                              <div className="flex-1 text-center md:text-left">
                                  <h3 className="text-xl font-bold text-white">{brawler.name}</h3>
                                  <div className="flex items-center justify-center md:justify-start gap-4 mt-1 text-sm">
                                      <div className="text-gray-400">
                                          HP: <span className="text-white font-bold">{brawler.maxHp}</span> 
                                          <span className="text-green-400"> +{upgrade.extraHp}</span>
                                      </div>
                                      <div className="text-gray-400">
                                          ATK: <span className="text-white font-bold">{brawler.attack}</span>
                                          <span className="text-red-400"> +{upgrade.extraAttack}</span>
                                      </div>
                                  </div>
                              </div>

                              {/* Upgrade Action */}
                              <button 
                                  onClick={() => upgradeBrawler(brawler.id)}
                                  disabled={!canAfford}
                                  className={`
                                      flex flex-col items-center px-6 py-2 rounded-lg font-bold transition-all
                                      ${canAfford ? 'bg-orange-600 hover:bg-orange-500 hover:scale-105 shadow-[0_0_15px_rgba(234,88,12,0.4)]' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}
                                  `}
                              >
                                  <span className="text-xs uppercase opacity-80">Upgrade</span>
                                  <div className="flex items-center gap-1">
                                      <span className="text-yellow-400">$</span>
                                      <span className="text-lg">{cost}</span>
                                  </div>
                              </button>
                          </div>
                      );
                  })}
              </div>
            </div>
        );

        const renderShop = () => (
            <div className="flex flex-col items-center min-h-screen bg-slate-900 relative overflow-hidden pb-10">
              {renderCoinDisplay()}
              <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900 via-slate-900 to-black opacity-80"></div>

              <div className="relative z-10 w-full max-w-6xl mb-8 flex items-center justify-between px-4 absolute top-4">
                  <button 
                      onClick={goToMenu} 
                      className="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-white shadow-md transition-colors border border-gray-600"
                  >
                      ‚Üê Back
                  </button>
                </div>

                <div className="relative z-10 flex flex-col items-center mt-20 w-full">
                    <h2 className="text-4xl font-black text-white text-outline mb-10">BRAWL SHOP</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl w-full px-4 mb-16">
                        {BOXES.map(box => (
                            <div key={box.id} className="flex flex-col items-center group">
                                  <div className="relative">
                                      {/* Box visual */}
                                      <div 
                                          className={`
                                              w-56 h-56 ${box.color} rounded-3xl border-8 border-white/20 shadow-2xl
                                              flex items-center justify-center text-8xl cursor-pointer transition-transform duration-200
                                              ${boxState === 'SHAKING' && activeBox?.id === box.id ? 'animate-shake' : ''}
                                              ${boxState === 'IDLE' ? 'hover:scale-105' : ''}
                                              ${boxState !== 'IDLE' && activeBox?.id !== box.id ? 'opacity-30 scale-90 blur-sm' : ''}
                                          `}
                                          onClick={boxState === 'IDLE' ? () => openBox(box) : undefined}
                                      >
                                          {boxState === 'REVEALED' && activeBox?.id === box.id ? '‚ú®' : box.icon}
                                      </div>
                                      
                                      {/* Chances Badge */}
                                      <div className="absolute -top-3 -right-3 bg-black/80 text-white text-xs px-2 py-1 rounded-full border border-white/20">
                                          {(box.brawlerChance * 100)}% Brawler
                                      </div>
                                  </div>

                                  <div className="mt-6 text-center">
                                      <h3 className="text-2xl font-bold text-white mb-2">{box.name}</h3>
                                      <div className="text-gray-400 text-sm mb-4">
                                          Coins: {box.minCoins}-{box.maxCoins}
                                      </div>
                                      <button 
                                          onClick={() => openBox(box)}
                                          disabled={gameState.coins < box.cost || boxState !== 'IDLE'}
                                          className={`
                                              px-8 py-3 rounded-full font-black text-lg flex items-center justify-center gap-2 shadow-lg transition-all w-full
                                              ${gameState.coins >= box.cost && boxState === 'IDLE'
                                                  ? 'bg-yellow-500 hover:bg-yellow-400 text-black hover:scale-105 active:scale-95' 
                                                  : 'bg-gray-700 text-gray-500 cursor-not-allowed'}
                                          `}
                                      >
                                          <span className="text-yellow-900">$</span>
                                          <span>{box.cost}</span>
                                      </button>
                                  </div>
                            </div>
                        ))}
                    </div>

                    {/* Support Items Section */}
                    <div className="w-full max-w-4xl px-4">
                        <h3 className="text-2xl font-black text-white text-outline mb-6 border-b border-gray-700 pb-2">SUPPORT ITEMS</h3>
                        <div className="bg-slate-800 rounded-xl p-6 border border-gray-700 flex items-center justify-between shadow-lg">
                            <div className="flex items-center gap-4">
                                <div className="w-16 h-16 bg-green-900 rounded-lg flex items-center justify-center text-4xl border-2 border-green-500">
                                    üß™
                                </div>
                                <div>
                                    <h4 className="text-xl font-bold text-green-400">Healing Potion</h4>
                                    <p className="text-gray-400 text-sm">Heals <span className="text-white font-bold">{POTION_HEAL_AMOUNT} HP</span> in battle.</p>
                                    <p className="text-sm mt-1">Owned: <span className="text-yellow-400 font-bold">{gameState.potions}</span></p>
                                </div>
                            </div>
                            <button 
                                  onClick={buyPotion}
                                  disabled={gameState.coins < POTION_COST}
                                  className={`
                                      px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2 transition-all
                                      ${gameState.coins >= POTION_COST 
                                          ? 'bg-green-600 hover:bg-green-500 text-white hover:scale-105 shadow-[0_0_15px_rgba(22,163,74,0.4)]' 
                                          : 'bg-gray-700 text-gray-500 cursor-not-allowed'}
                                  `}
                              >
                                  <span className="text-yellow-400">$</span>
                                  {POTION_COST}
                              </button>
                        </div>
                    </div>

                    {boxState === 'REVEALED' && boxReward && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate-in fade-in duration-300">
                            <div className="bg-slate-800 p-8 rounded-2xl border-4 border-yellow-500 max-w-sm w-full text-center relative overflow-hidden">
                                <div className="absolute top-0 inset-x-0 h-32 bg-gradient-to-b from-yellow-500/20 to-transparent pointer-events-none"></div>
                                
                                <h3 className="text-3xl font-black text-white text-outline mb-6 relative z-10">
                                    {boxReward.type === 'NEW_BRAWLER' ? 'NEW BRAWLER!' : boxReward.type === 'DUPLICATE' ? 'DUPLICATE!' : 'COINS!'}
                                </h3>
                                
                                {boxReward.type === 'COINS' ? (
                                    <div className="flex justify-center mb-6 py-8">
                                        <div className="text-8xl animate-bounce">üí∞</div>
                                    </div>
                                ) : (
                                    boxReward.item && (
                                      <div className="flex justify-center mb-6">
                                          <div className="w-32 h-32 rounded-full border-4 border-white overflow-hidden shadow-2xl">
                                              <img src={boxReward.item.avatarUrl} alt={boxReward.item.name} className="w-full h-full object-cover" />
                                          </div>
                                      </div>
                                    )
                                )}

                                {boxReward.item && (
                                    <>
                                      <div className="text-xl font-bold text-white mb-2">{boxReward.item?.name}</div>
                                      <div className="text-purple-300 font-bold text-sm uppercase mb-6">{boxReward.item?.class}</div>
                                    </>
                                )}

                                {(boxReward.type === 'DUPLICATE' || boxReward.type === 'COINS') && (
                                    <div className="bg-gray-700/50 p-4 rounded-xl mb-6">
                                        <p className="text-gray-300 text-sm mb-2">{boxReward.type === 'DUPLICATE' ? 'Converted to Coins' : 'Found in box'}</p>
                                        <div className="flex justify-center items-center gap-2 text-yellow-400 font-black text-4xl">
                                            <span>+ {boxReward.coins}</span>
                                            <span className="text-lg bg-yellow-500 text-black px-2 rounded-full">$</span>
                                        </div>
                                    </div>
                                )}

                                <button 
                                  onClick={closeBoxReveal}
                                  className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition-transform hover:scale-105"
                                >
                                    COLLECT
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );

        const renderCharacterSelect = () => (
          <div className="flex flex-col items-center min-h-screen bg-slate-900 relative pb-32">
            {renderCoinDisplay()}

            <div className="w-full max-w-6xl p-4 flex items-center justify-between sticky top-0 bg-slate-900/95 backdrop-blur z-30 border-b border-gray-800 mb-6">
              <button 
                  onClick={goToMenu} 
                  className="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-white shadow-md transition-colors border border-gray-600"
              >
                  ‚Üê Back
              </button>
              <h2 className="text-2xl md:text-3xl font-bold text-white text-center flex-1">SELECT BRAWLER</h2>
              <div className="w-20"></div> {/* Spacer for centering */}
            </div>

            <div className="max-w-6xl w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 px-4">
                {BRAWLERS.map(brawler => {
                  const isLocked = !gameState.unlockedBrawlerIds.includes(brawler.id);
                  const canBuy = gameState.coins >= brawler.price;
                  const isSelected = selectedBrawlerId === brawler.id;
                  const upgrade = gameState.brawlerUpgrades[brawler.id];
                  
                  // Create a display brawler that includes upgrades for the card view
                  const displayBrawler = upgrade ? {
                      ...brawler,
                      hp: brawler.hp + upgrade.extraHp,
                      maxHp: brawler.maxHp + upgrade.extraHp,
                      attack: brawler.attack + upgrade.extraAttack
                  } : brawler;

                  return (
                      <div key={brawler.id} className="relative">
                          <BrawlerCard 
                              brawler={displayBrawler} 
                              isLocked={isLocked}
                              isSelected={isSelected}
                              canBuy={canBuy}
                              onBuy={(e) => {
                                  e.stopPropagation();
                                  buyBrawler(brawler);
                              }}
                              onClick={() => selectBrawler(brawler)}
                          />
                          {upgrade && !isLocked && (
                              <div className="absolute top-2 right-2 z-20 bg-orange-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow">
                                  Lv.{upgrade.level}
                              </div>
                          )}
                      </div>
                  );
                })}
              </div>

              {/* Floating Start Button Footer */}
              {selectedBrawlerId && (
                  <div className="fixed bottom-0 inset-x-0 bg-slate-800/90 backdrop-blur-md border-t border-yellow-500/50 p-6 z-40 flex justify-center animate-in slide-in-from-bottom duration-300">
                      <button
                          onClick={startGame}
                          className="bg-yellow-500 hover:bg-yellow-400 text-black font-black text-3xl py-4 px-20 rounded-2xl shadow-[0_0_30px_rgba(234,179,8,0.5)] hover:shadow-[0_0_50px_rgba(234,179,8,0.8)] transform hover:scale-105 transition-all flex flex-col items-center"
                      >
                          BATTLE START
                          <span className="text-sm font-bold opacity-70">
                              with {BRAWLERS.find(b => b.id === selectedBrawlerId)?.name}
                          </span>
                      </button>
                  </div>
              )}
          </div>
        );

        const renderBattle = () => {
          if (!gameState.player || !gameState.enemy) return null;

          return (
            <div className="flex flex-col h-screen bg-slate-900 overflow-hidden">
              {/* Header / Commentary */}
              <div className="bg-slate-800 p-4 shadow-lg z-20 border-b border-slate-700 relative">
                
                {/* Home Button */}
                <button 
                  onClick={goToMenu}
                  className="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-gray-700 hover:bg-gray-600 rounded-lg border border-gray-500 transition-colors"
                  title="Î©îÏù∏ Î©îÎâ¥Î°ú ÎÇòÍ∞ÄÍ∏∞"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                  </svg>
                </button>

                {/* Coins in Battle */}
                <div className="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-yellow-500/20">
                  <div className="w-4 h-4 rounded-full bg-yellow-400 flex items-center justify-center text-[10px] text-yellow-900 font-bold">$</div>
                  <span className="text-yellow-400 font-bold">{gameState.coins.toLocaleString()}</span>
                </div>

                <div className="max-w-3xl mx-auto text-center pt-1 md:pt-0">
                  <div className="inline-block px-4 py-1 rounded-full bg-yellow-500 text-black font-bold text-xs mb-2">
                    BATTLE LOG
                  </div>
                  <p className="text-lg md:text-xl font-bold text-white animate-pulse truncate px-10">
                    "{gameState.commentary}"
                  </p>
                </div>
              </div>

              {/* Battle Arena */}
              <div className="flex-1 flex flex-col items-center justify-center p-4 relative bg-[url('https://picsum.photos/seed/brawlbg/1920/1080')] bg-cover bg-center">
                  {/* Overlay for readability */}
                  <div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

                  <div className="relative z-10 w-full max-w-5xl grid grid-cols-2 gap-8 md:gap-16 items-center">
                      {/* Player Side */}
                      <div className="flex flex-col items-center">
                          <div className="mb-4">
                              <span className="bg-blue-600 text-white px-3 py-1 rounded font-bold text-sm">YOU</span>
                          </div>
                          <BrawlerCard 
                              brawler={gameState.player} 
                              isPlayer={true} 
                              showHealthBar={true} 
                              isActive={gameState.turn === 'PLAYER'}
                              isDamaged={damageEffect === 'player'}
                          />
                      </div>

                      {/* VS Graphic */}
                      <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 pointer-events-none hidden md:block">
                          <span className="text-6xl font-black text-white italic text-outline drop-shadow-[0_0_15px_rgba(255,0,0,0.8)]">VS</span>
                      </div>

                      {/* Enemy Side */}
                      <div className="flex flex-col items-center">
                          <div className="mb-4">
                              <span className="bg-red-600 text-white px-3 py-1 rounded font-bold text-sm">ENEMY</span>
                          </div>
                          <BrawlerCard 
                              brawler={gameState.enemy} 
                              isPlayer={false} 
                              showHealthBar={true} 
                              isActive={gameState.turn === 'ENEMY'}
                              isDamaged={damageEffect === 'enemy'}
                          />
                      </div>
                  </div>
              </div>

              {/* Controls & Log */}
              <div className="bg-slate-800 p-4 border-t border-slate-700 h-1/3 flex flex-col md:flex-row gap-4 max-w-6xl mx-auto w-full">
                  {/* Action Buttons */}
                  <div className="flex-1 flex flex-col justify-center gap-3">
                      <div className="flex gap-2">
                          <button 
                              disabled={gameState.turn !== 'PLAYER' || isProcessing}
                              onClick={() => handlePlayerAction('ATTACK')}
                              className={`
                                  flex-1 py-4 px-2 rounded-xl font-black text-lg tracking-wider shadow-[0_4px_0_rgb(0,0,0,0.3)] active:shadow-none active:translate-y-1 transition-all
                                  ${gameState.turn === 'PLAYER' && !isProcessing 
                                      ? 'bg-red-500 hover:bg-red-400 text-white' 
                                      : 'bg-gray-600 text-gray-400 cursor-not-allowed'}
                              `}
                          >
                              ATTACK ({gameState.player.attack})
                          </button>
                          <button 
                              disabled={gameState.turn !== 'PLAYER' || isProcessing || gameState.potions <= 0 || gameState.player.hp >= gameState.player.maxHp}
                              onClick={() => handlePlayerAction('POTION')}
                              className={`
                                  py-4 px-4 rounded-xl font-black text-lg shadow-[0_4px_0_rgb(0,0,0,0.3)] active:shadow-none active:translate-y-1 transition-all flex flex-col items-center justify-center leading-none min-w-[80px]
                                  ${gameState.turn === 'PLAYER' && !isProcessing && gameState.potions > 0 && gameState.player.hp < gameState.player.maxHp
                                      ? 'bg-green-600 hover:bg-green-500 text-white' 
                                      : 'bg-gray-700 text-gray-500 cursor-not-allowed opacity-70'}
                              `}
                              title={`Heal ${POTION_HEAL_AMOUNT} HP`}
                          >
                              <span>üß™</span>
                              <span className="text-xs mt-1">x{gameState.potions}</span>
                          </button>
                      </div>
                      
                      <button 
                          disabled={gameState.turn !== 'PLAYER' || isProcessing || gameState.player.superCharge < 100}
                          onClick={() => handlePlayerAction('SUPER')}
                          className={`
                              relative py-4 px-6 rounded-xl font-black text-xl tracking-wider shadow-[0_4px_0_rgb(0,0,0,0.3)] active:shadow-none active:translate-y-1 transition-all overflow-hidden
                              ${gameState.turn === 'PLAYER' && !isProcessing && gameState.player.superCharge >= 100
                                  ? 'bg-yellow-400 hover:bg-yellow-300 text-black' 
                                  : 'bg-gray-700 text-gray-500 cursor-not-allowed'}
                          `}
                      >
                          <span className="relative z-10">SUPER!</span>
                          {gameState.player.superCharge >= 100 && (
                              <div className="absolute inset-0 bg-white/30 animate-pulse z-0"></div>
                          )}
                          {/* Charge Indicator if not full */}
                          {gameState.player.superCharge < 100 && (
                              <div 
                                  className="absolute left-0 bottom-0 top-0 bg-yellow-600/30 transition-all duration-300"
                                  style={{width: `${gameState.player.superCharge}%`}}
                              ></div>
                          )}
                      </button>
                  </div>

                  {/* Game Log */}
                  <div className="flex-[2] bg-black/30 rounded-lg p-4 overflow-y-auto font-mono text-sm h-full scrollbar-hide border border-slate-600">
                      {gameState.log.map((entry) => (
                          <div key={entry.id} className={`mb-1 ${
                              entry.type === 'damage' ? 'text-red-400' : 
                              entry.type === 'heal' ? 'text-green-400' : 
                              entry.type === 'super' ? 'text-yellow-400 font-bold' : 
                              'text-gray-300'
                          }`}>
                              {`> ${entry.text}`}
                          </div>
                      ))}
                      <div ref={logsEndRef} />
                  </div>
              </div>
            </div>
          );
        };

        const renderVictory = () => (
          <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-center p-4">
            <h1 className="text-6xl font-black text-yellow-400 mb-4 animate-bounce">VICTORY!</h1>
            <p className="text-2xl text-white mb-6">{gameState.enemy?.name}ÏùÑ(Î•º) Î¨ºÎ¶¨Ï≥§ÏäµÎãàÎã§!</p>
            
            {/* Reward Display */}
            <div className="bg-slate-800 p-6 rounded-xl border-2 border-yellow-500 mb-8 animate-pulse shadow-[0_0_30px_rgba(234,179,8,0.3)]">
                <p className="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Battle Reward</p>
                <div className="flex items-center justify-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-yellow-400 border-4 border-yellow-200 flex items-center justify-center shadow-inner text-yellow-800 font-black text-xl">$</div>
                    <span className="text-5xl font-black text-white">+{gameState.lastReward}</span>
                </div>
                <p className="mt-4 text-yellow-500 font-bold">Total: {gameState.coins.toLocaleString()} Coins</p>
            </div>

            <div className="flex gap-4">
              <button 
                onClick={nextLevel}
                className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transform transition hover:scale-105"
              >
                Îã§Ïùå Ï†ÑÌà¨Î°ú Ïù¥Îèô
              </button>
              <button 
                onClick={goToMenu}
                className="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg"
              >
                Î©îÏù∏ Î©îÎâ¥
              </button>
            </div>
          </div>
        );

        const renderDefeat = () => (
          <div className="flex flex-col items-center justify-center min-h-screen bg-red-950 text-center p-4">
            <h1 className="text-6xl font-black text-gray-300 mb-8">DEFEAT</h1>
            <p className="text-2xl text-red-200 mb-8">Í≤åÏûÑ Ïò§Î≤Ñ...</p>
            <p className="text-xl text-white mb-8">Ï¥ù ÏäπÎ¶¨ ÌöüÏàò: {gameState.wins}</p>
            <p className="text-xl text-yellow-400 mb-8 font-bold">ÌöçÎìù ÏΩîÏù∏: {gameState.coins}</p>
            <button 
                onClick={goToMenu}
                className="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-8 rounded-full text-xl shadow-lg transform transition hover:scale-105"
              >
                Îã§Ïãú ÎèÑÏ†ÑÌïòÍ∏∞
            </button>
          </div>
        );

        return (
          <div className="min-h-screen bg-slate-900 text-white font-sans select-none">
            {gameState.status === 'MENU' && renderMenu()}
            {gameState.status === 'SELECT_CHARACTER' && renderCharacterSelect()}
            {gameState.status === 'SHOP' && renderShop()}
            {gameState.status === 'BLACKSMITH' && renderBlacksmith()}
            {gameState.status === 'BATTLE' && renderBattle()}
            {gameState.status === 'VICTORY' && renderVictory()}
            {gameState.status === 'DEFEAT' && renderDefeat()}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>